cmake_minimum_required(VERSION 3.21)

project(hdf5-static-linking-test-superbuild)

include(ExternalProject)

ExternalProject_Add(
    zlib
    SOURCE_DIR ${CMAKE_CURRENT_LIST_DIR}/3rd-party/zlib
    INSTALL_DIR ${CMAKE_CURRENT_BINARY_DIR}/install
    CMAKE_ARGS
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INSTALL_PREFIX:PATH=<INSTALL_DIR>
        -DCMAKE_PREFIX_PATH:PATH=<INSTALL_DIR>
)

ExternalProject_Add(
    hdf5
    DEPENDS zlib 
    SOURCE_DIR ${CMAKE_CURRENT_LIST_DIR}/3rd-party/hdf5
    INSTALL_DIR ${CMAKE_CURRENT_BINARY_DIR}/install
    CMAKE_ARGS
        -DBUILD_SHARED_LIBS=OFF
        -DBUILD_STATIC_LIBS=ON
        -DBUILD_TESTING=OFF
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INSTALL_PREFIX:PATH=<INSTALL_DIR>
        -DCMAKE_PREFIX_PATH:PATH=<INSTALL_DIR>
        -DHDF5_BUILD_EXAMPLES=OFF
        -DHDF5_BUILD_CPP_LIB=OFF
        -DHDF5_BUILD_FORTRAN=OFF
        -DHDF5_BUILD_HL_LIB=OFF
        -DHDF5_BUILD_TOOLS=OFF
        -DHDF5_ENABLE_PARALLEL=OFF
        -DHDF5_ENABLE_THREADSAFE=OFF
        -DHDF5_ENABLE_SZIP_ENCODING=OFF
        -DHDF5_ENABLE_SZIP_SUPPORT=OFF
        -DHDF5_ENABLE_Z_LIB_SUPPORT=ON
        -DZLIB_USE_STATIC_LIBS=ON
)

ExternalProject_Add(
    test
    DEPENDS hdf5
    SOURCE_DIR ${CMAKE_CURRENT_LIST_DIR}/test
    INSTALL_DIR ${CMAKE_CURRENT_BINARY_DIR}/install
    CMAKE_ARGS
        -DBUILD_SHARED_LIBS=OFF
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INSTALL_PREFIX:PATH=<INSTALL_DIR>
        -DCMAKE_PREFIX_PATH:PATH=<INSTALL_DIR>
        -DCMAKE_INSTALL_RPATH:STRING=<INSTALL_DIR>/lib
        -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON
        -DZLIB_USE_STATIC_LIBS=ON
)
